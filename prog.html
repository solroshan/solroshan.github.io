<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="/assets/css/images/leaf.png" rel="shortcut icon" type="image/png" />
  <title>GrassCare Programlar</title>

  <!-- Tailwind + React + Babel -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const supabaseUrl = 'https://puurwgrzknxttjsjxdit.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1dXJ3Z3J6a254dHRqc2p4ZGl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NTIyODUsImV4cCI6MjA4MTAyODI4NX0.tYoFbwWeuPCAXLXVp8yX0ThbvWPgboYOCUqPuKtAoaI';
    window.supabase = supabase.createClient(supabaseUrl, supabaseKey); /* [web:498] */
  </script>

  <!-- Ortak Header -->
  <script type="text/babel" src="./components/public-header.js"></script>

  <!-- Ortak bileşenler -->
  <script type="text/babel" src="./components/icons.js"></script>
  <script type="text/babel" src="./components/Footer.js"></script>
  <script type="text/babel" src="./components/ToggleSwitch.js"></script>
  <script type="text/babel" src="./components/ConfirmModal.js"></script>
  <script type="text/babel" src="./components/NewProgramForm.js"></script>
  <script type="text/babel" src="./components/ProgramList.js"></script>

  <style>
    .btn-soft {
      transition: box-shadow .18s, background .18s, color .18s;
    }
    .btn-soft:hover {
      box-shadow: 0 6px 18px rgba(2,6,23,0.18), 0 1.5px 8px rgba(20,184,166,0.09);
      background: linear-gradient(90deg, #0891b2 0%, #0ea5e9 100%);
      color: #fff;
    }
  </style>
</head>
<body class="bg-slate-900 font-sans text-slate-100">
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const { createRoot } = ReactDOM;

    const daysOfWeek = ["Pzt", "Sal", "Çar", "Per", "Cum", "Cts", "Paz"];

    const ProgramPage = () => {
      const [user, setUser] = useState(null);
      const [loadingUser, setLoadingUser] = useState(true);

      const [valves, setValves] = useState([]);       // Supabase'ten gelen ham valf verisi
      const [programs, setPrograms] = useState([]);   // UI'da kullandığımız program görünümleri
      const [loadingValves, setLoadingValves] = useState(true);

      const [form, setForm] = useState({ name: '', time: '', duration: '', days: [], valves: [] });
      const [confirmDeleteId, setConfirmDeleteId] = useState(null);
      const [saving, setSaving] = useState(false);

      // Benzersiz grup listesi (valves.tablosundaki group alanından)
      const groups = useMemo(
        () => Array.from(new Set(valves.map(v => v.group).filter(Boolean))).sort(),
        [valves]
      );

      // 1) Kullanıcıyı al
      useEffect(() => {
        const loadUser = async () => {
          const { data, error } = await supabase.auth.getUser(); /* [web:123] */
          if (error || !data?.user) {
            window.location.href = 'anasayfa.html#giris';
            return;
          }
          setUser(data.user);
          setLoadingUser(false);
        };
        loadUser();
      }, []);

      // 2) Kullanıcı geldikten sonra valfleri çek
      useEffect(() => {
        if (!user) return;

        const loadValves = async () => {
          setLoadingValves(true);
          const { data, error } = await supabase
            .from('valves')
            .select('*')
            .eq('user_id', user.id)
            .order('created_at', { ascending: true }); /* [web:386] */

          if (error) {
            console.error('Valfler alınamadı:', error);
            setValves([]);
            setPrograms([]);
          } else {
            setValves(data || []);
            // Program görünümü: aynı program adına sahip grupları gruplayabilirsin;
            // şimdilik her valfi ayrı satır gibi kullanıyoruz.
            const mapped = (data || []).map(v => ({
              id: v.id,
              name: v.program || v.name,
              time: '',             // SQL şeman yok; istersen program metnine gömersin
              duration: '',         // süre kolonun yoksa burada boş bırakılır
              days: [],             // gün bilgisi yok; ileride colon ekleyebilirsin
              valves: [v.group].filter(Boolean),
              active: v.status === 'AÇIK',
              editing: false,
            }));
            setPrograms(mapped);
          }
          setLoadingValves(false);
        };

        loadValves();
      }, [user]);

      // 3) Yeni program oluşturma:
      // şu an "program" alanını ve "status" / "group" alanlarını güncelliyoruz.
      const createProgram = async () => {
        if (!form.name || !form.time || !form.duration || form.valves.length === 0) return;
        if (!user) return;

        setSaving(true);
        try {
          // Seçili her grup için birer valf kaydı oluşturmak istiyorsan:
          const rows = form.valves.map(group => ({
            user_id: user.id,
            name: `Program · ${group}`,
            status: 'AÇIK',
            program: `${form.name} · ${form.time} · ${form.duration} dk`,
            mode: 'Auto',
            group,
          }));

          const { data, error } = await supabase
            .from('valves')
            .insert(rows)
            .select(); /* [web:498][web:490] */

          if (error) {
            alert('Program kaydedilemedi: ' + error.message);
            return;
          }

          // UI state'i güncelle
          const newValves = [...valves, ...(data || [])];
          setValves(newValves);

          const mappedNew = (data || []).map(v => ({
            id: v.id,
            name: v.program || v.name,
            time: '',
            duration: '',
            days: [],
            valves: [v.group].filter(Boolean),
            active: v.status === 'AÇIK',
            editing: false,
          }));

          setPrograms(prev => [...mappedNew, ...prev]);

          setForm({ name: '', time: '', duration: '', days: [], valves: [] });
        } finally {
          setSaving(false);
        }
      };

      // 4) Aktif/pasif toggle (status AÇIK/KAPALI)
      const toggleActive = async (id) => {
        const target = valves.find(v => v.id === id);
        if (!target) return;

        const newStatus = target.status === 'AÇIK' ? 'KAPALI' : 'AÇIK';

        const { error } = await supabase
          .from('valves')
          .update({ status: newStatus })
          .eq('id', id);

        if (error) {
          alert('Durum güncellenemedi: ' + error.message);
          return;
        }

        setValves(prev => prev.map(v => v.id === id ? { ...v, status: newStatus } : v));
        setPrograms(prev => prev.map(p => p.id === id ? { ...p, active: newStatus === 'AÇIK' } : p));
      };

      // 5) Program ismi / metni düzenleme (sadece local edit flag)
      const toggleEdit = (id) => {
        setPrograms(prev => prev.map(p => p.id === id ? { ...p, editing: !p.editing } : p));
      };

      // 6) Silme
      const askDelete = (id) => setConfirmDeleteId(id);
      const cancelDelete = () => setConfirmDeleteId(null);
      const doDelete = async () => {
        if (!confirmDeleteId) return;

        const { error } = await supabase
          .from('valves')
          .delete()
          .eq('id', confirmDeleteId); /* [web:490] */

        if (error) {
          alert('Program silinemedi: ' + error.message);
          return;
        }

        setValves(prev => prev.filter(v => v.id !== confirmDeleteId));
        setPrograms(prev => prev.filter(p => p.id !== confirmDeleteId));
        setConfirmDeleteId(null);
      };

      // 7) Kopyalama: yeni kayıt insert
      const copyProgram = async (id) => {
        const srcValve = valves.find(v => v.id === id);
        if (!srcValve || !user) return;

        const insertRow = {
          user_id: user.id,
          name: srcValve.name,
          status: srcValve.status,
          program: (srcValve.program || srcValve.name) + ' (Kopya)',
          mode: srcValve.mode,
          group: srcValve.group,
        };

        const { data, error } = await supabase
          .from('valves')
          .insert(insertRow)
          .select()
          .single();

        if (error) {
          alert('Kopya oluşturulamadı: ' + error.message);
          return;
        }

        setValves(prev => [...prev, data]);

        const mapped = {
          id: data.id,
          name: data.program || data.name,
          time: '',
          duration: '',
          days: [],
          valves: [data.group].filter(Boolean),
          active: data.status === 'AÇIK',
          editing: false,
        };
        setPrograms(prev => [mapped, ...prev]);
      };

      // 8) Formda grup seçimi (valf grupları)
      const toggleGroupInForm = (group) => {
        setForm(prev => prev.valves.includes(group)
          ? { ...prev, valves: prev.valves.filter(g => g !== group) }
          : { ...prev, valves: [...prev.valves, group] });
      };

      // 9) Formda gün seçimi (şimdilik sadece UI, DB'ye yazmıyoruz)
      const toggleDayInForm = (day) => {
        setForm(prev => prev.days.includes(day)
          ? { ...prev, days: prev.days.filter(d => d !== day) }
          : { ...prev, days: [...prev.days, day] });
      };

      // 10) Mevcut programda grup toggle:
      // Şu anda valves tablosunda tek bir group alanı olduğu için,
      // bu fonksiyon backend'le bire bir uyumlu değil; o yüzden sadece UI'da kullanma.
      const toggleGroupInProgram = (id, group) => {
        setPrograms(prev => prev.map(p => p.id === id
          ? {
              ...p,
              valves: p.valves.includes(group)
                ? p.valves.filter(g => g !== group)
                : [...p.valves, group],
            }
          : p));
      };

      if (loadingUser || loadingValves) {
        return (
          <div className="min-h-screen flex flex-col">
            <window.Header />
            <main className="flex-1 flex items-center justify-center">
              <div className="text-slate-300">Yükleniyor...</div>
            </main>
            <window.Footer />
          </div>
        );
      }

      return (
        <div className="min-h-screen flex flex-col">
          <window.Header />
          <main className="flex-1">
            <div className="max-w-6xl mx-auto px-3 py-4 md:px-6 md:py-8">
              <div className="bg-slate-900 rounded-2xl p-6">
                <div className="grid grid-cols-1 gap-4 sm:gap-6 mb-6">
                  <NewProgramForm
                    form={form}
                    setForm={setForm}
                    groups={groups}
                    daysOfWeek={daysOfWeek}
                    onCreate={createProgram}
                    toggleGroupInForm={toggleGroupInForm}
                    toggleDayInForm={toggleDayInForm}
                    saving={saving}
                  />
                  <ProgramList
                    programs={programs}
                    groups={groups}
                    toggleActive={toggleActive}
                    toggleEdit={toggleEdit}
                    copyProgram={copyProgram}
                    askDelete={askDelete}
                    toggleGroupInProgram={toggleGroupInProgram}
                  />
                </div>
              </div>
            </div>
          </main>
          <window.Footer />
          <ConfirmModal
            open={confirmDeleteId !== null}
            title="Programı Sil"
            text="Bu programı silmek istediğinize emin misiniz? Bu işlem geri alınamaz."
            onCancel={cancelDelete}
            onConfirm={doDelete}
          />
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<ProgramPage />);
  </script>
</body>
</html>
