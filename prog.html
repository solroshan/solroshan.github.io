<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="/assets/css/images/leaf.png" rel="shortcut icon" type="image/png" />
  <title>GrassCare Programlar</title>

  <!-- Tailwind + React + Babel önce -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase UMD (anasayfadakiyle aynı) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const supabaseUrl = 'https://puurwgrzknxttjsjxdit.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1dXJ3Z3J6a254dHRqc2p4ZGl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NTIyODUsImV4cCI6MjA4MTAyODI4NX0.tYoFbwWeuPCAXLXVp8yX0ThbvWPgboYOCUqPuKtAoaI';
    window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
  </script>

  <!-- ORTAK HEADER (anasayfa ile aynı) -->
  <script type="text/babel" src="./components/public-header.js"></script>

  <style>
    .btn-soft {
      transition: box-shadow .18s, background .18s, color .18s;
    }
    .btn-soft:hover {
      box-shadow: 0 6px 18px rgba(2,6,23,0.18), 0 1.5px 8px rgba(20,184,166,0.09);
      background: linear-gradient(90deg, #0891b2 0%, #0ea5e9 100%);
      color: #fff;
    }
  </style>
</head>
<body class="bg-slate-900 font-sans text-slate-100">
  <div id="root" class="min-h-screen"></div>

  <!-- COMPONENTS -->
  <script type="text/babel" src="./components/icons.js"></script>
  <script type="text/babel" src="./components/Footer.js"></script>
  <script type="text/babel" src="./components/ToggleSwitch.js"></script>
  <script type="text/babel" src="./components/ConfirmModal.js"></script>
  <script type="text/babel" src="./components/NewProgramForm.js"></script>
  <script type="text/babel" src="./components/ProgramList.js"></script>

  <script type="text/babel">
    const { useState, useMemo } = React;
    const { createRoot } = ReactDOM;

    const initialValves = [
      { id: 1, name: 'V1', group: 'Ön' },
      { id: 2, name: 'V2', group: 'Ön' },
      { id: 3, name: 'V3', group: 'Orta' },
      { id: 4, name: 'V4', group: 'Orta' },
      { id: 5, name: 'V5', group: 'Orta' },
      { id: 6, name: 'V6', group: 'Arka' },
      { id: 7, name: 'V7', group: 'Arka' },
    ];

    const initialPrograms = [
      { id: 1, name: "Yaz Programı", time: "06:00", duration: 30, days: ["Pzt","Sal","Çar","Per","Cum","Cts","Paz"], valves: ["Ön","Orta","Arka"], active: true, editing: false },
      { id: 2, name: "Kış Programı", time: "13:30", duration: 20, days: ["Pzt","Per"], valves: ["Ön","Orta","Arka"], active: false, editing: false },
    ];

    const ProgramPage = () => {
      const [programs, setPrograms] = useState(initialPrograms);
      const [form, setForm] = useState({ name: '', time: '', duration: '', days: [], valves: [] });
      const [confirmDeleteId, setConfirmDeleteId] = useState(null);
      
      const daysOfWeek = ["Pzt", "Sal", "Çar", "Per", "Cum", "Cts", "Paz"];
      const groups = useMemo(() => Array.from(new Set(initialValves.map(v => v.group))).sort(), []);

      const createProgram = () => {
        if (!form.name || !form.time || !form.duration) return;
        const newProg = { 
          id: Date.now(), 
          ...form, 
          days: form.days.length > 0 ? form.days : ["Pzt","Sal"], 
          active: true, 
          editing: false 
        };
        setPrograms(prev => [newProg, ...prev]);
        setForm({ name: '', time: '', duration: '', days: [], valves: [] });
      };

      const toggleActive = id => {
        setPrograms(prev => prev.map(p => p.id === id ? { ...p, active: !p.active } : p));
      };

      const toggleEdit = id => {
        setPrograms(prev => prev.map(p => p.id === id ? { ...p, editing: !p.editing } : p));
      };

      const askDelete = id => setConfirmDeleteId(id);
      const cancelDelete = () => setConfirmDeleteId(null);
      const doDelete = () => {
        setPrograms(prev => prev.filter(p => p.id !== confirmDeleteId));
        setConfirmDeleteId(null);
      };

      const copyProgram = id => {
        const src = programs.find(p => p.id === id);
        if (!src) return;
        const copy = { ...src, id: Date.now(), name: `${src.name} (Kopya)` };
        setPrograms(prev => [copy, ...prev]);
      };

      const toggleGroupInForm = (group) => {
        setForm(prev => prev.valves.includes(group)
          ? { ...prev, valves: prev.valves.filter(g => g !== group) }
          : { ...prev, valves: [...prev.valves, group] });
      };

      const toggleDayInForm = (day) => {
        setForm(prev => prev.days.includes(day)
          ? { ...prev, days: prev.days.filter(d => d !== day) }
          : { ...prev, days: [...prev.days, day] });
      };

      const toggleGroupInProgram = (id, group) => {
        setPrograms(prev => prev.map(p => p.id === id
          ? { ...p, valves: p.valves.includes(group) ? p.valves.filter(g => g !== group) : [...p.valves, group] }
          : p));
      };

      return (
        <div className="min-h-screen flex flex-col">
          <window.Header /> {/* Anasayfadaki ile aynı ortak header */}
          <main className="flex-1">
            <div className="max-w-6xl mx-auto px-3 py-4 md:px-6 md:py-8">
              <div className="bg-slate-900 rounded-2xl p-6">
                <div className="grid grid-cols-1 gap-4 sm:gap-6 mb-6">
                  <NewProgramForm 
                    form={form} 
                    setForm={setForm} 
                    groups={groups} 
                    daysOfWeek={daysOfWeek}
                    onCreate={createProgram} 
                    toggleGroupInForm={toggleGroupInForm} 
                    toggleDayInForm={toggleDayInForm} 
                  />
                  <ProgramList 
                    programs={programs} 
                    groups={groups} 
                    toggleActive={toggleActive} 
                    toggleEdit={toggleEdit}
                    copyProgram={copyProgram} 
                    askDelete={askDelete} 
                    toggleGroupInProgram={toggleGroupInProgram}
                  />
                </div>
              </div>
            </div>
          </main>
          <Footer />
          <ConfirmModal
            open={confirmDeleteId !== null}
            title="Programı Sil"
            text="Bu programı silmek istediğinize emin misiniz? Bu işlem geri alınamaz."
            onCancel={cancelDelete}
            onConfirm={doDelete}
          />
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<ProgramPage />);
  </script>
</body>
</html>
