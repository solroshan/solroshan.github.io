<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="/assets/css/images/leaf.png" rel="shortcut icon" type="image/png" />
  <title>GrassCare Kullanıcı Paneli</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- React + ReactDOM + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    const supabaseUrl = 'https://puurwgrzknxttjsjxdit.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1dXJ3Z3J6a254dHRqc2p4ZGl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NTIyODUsImV4cCI6MjA4MTAyODI4NX0.tYoFbwWeuPCAXLXVp8yX0ThbvWPgboYOCUqPuKtAoaI';
    window.supabase = supabase.createClient(supabaseUrl, supabaseKey);
  </script>

  <style>
    .btn-soft { transition: box-shadow .18s, background .18s, color .18s; }
    .btn-soft:hover {
      box-shadow: 0 6px 18px rgba(2,6,23,0.18), 0 1.5px 8px rgba(20,184,166,0.09);
      background: linear-gradient(90deg, #0891b2 0%, #0ea5e9 100%);
      color: #fff;
    }
  </style>
</head>

<body class="bg-slate-900 font-sans text-slate-100">
  <div id="root"></div>

  <!-- Ortak komponentler -->
  <script type="text/babel" src="./components/public-header.js"></script>
  <script type="text/babel" src="./components/icons.js"></script>
  <script type="text/babel" src="./components/Footer.js"></script>
  <script type="text/babel" src="./components/ToggleSwitch.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    // AUTH KONTROLÜ - Sayfa yüklenirken çalışır
    useEffect(() => {
      const checkAuth = async () => {
        try {
          const { data: { user }, error } = await supabase.auth.getUser();
          
          if (error || !user) {
            // Giriş yapılmamışsa anasayfaya yönlendir
            window.location.href = 'anasayfa.html#giris';
            return;
          }
          
          console.log('Kullanıcı doğrulandı:', user.email);
        } catch (err) {
          console.error('Auth kontrol hatası:', err);
          window.location.href = 'anasayfa.html#giris';
        }
      };
      
      checkAuth();
    }, []);

    // Geri kalan tüm kodlar aynı...
    const SearchIcon = () => (
      <svg className="h-5 w-5 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
        <path clipRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" fillRule="evenodd"></path>
      </svg>
    );

    const FilterIcon = () => (
      <svg className="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
        <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"></path>
      </svg>
    );

    const CheckIcon = () => (
      <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
        <path clipRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" fillRule="evenodd"></path>
      </svg>
    );

    const CloseIcon = () => (
      <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
        <path clipRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.697a1 1 0 010-1.414z" fillRule="evenodd"></path>
      </svg>
    );

    const PauseIcon = () => (
      <svg className="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
        <path clipRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 000-2H9V8a1 1 0 00-1-1z" fillRule="evenodd"></path>
      </svg>
    );

    // ValveCard, GroupModal, AddValveModal komponentleri aynı...
    const ValveCard = ({ valve, onToggle }) => {
      const isChecked = valve.status === 'AÇIK';
      return (
        <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-4 shadow-md border border-slate-700/40 flex flex-col items-stretch space-y-3">
          <div className="w-full flex justify-between items-center">
            <h4 className="font-semibold text-slate-100 text-sm">
              {valve.name} {valve.group ? <span className="text-[11px] text-slate-400">· {valve.group}</span> : null}
            </h4>
            <span className={`text-[11px] font-semibold px-2.5 py-0.5 rounded-md ${isChecked ? 'bg-teal-600/40 text-teal-200 border border-teal-400/60' : 'bg-slate-700 text-slate-200 border border-slate-600'}`}>
              {valve.status}
            </span>
          </div>
          <window.ToggleSwitch checked={isChecked} onChange={() => onToggle(valve.id)} />
          <span className="text-[11px] font-medium text-slate-400">{valve.mode}</span>
          <div className="w-full bg-slate-800 border border-slate-700 rounded-md p-2.5">
            <div className="flex justify-between items-center">
              <p className="text-xs text-slate-400">Program</p>
              <button className="text-xs font-semibold bg-slate-900 text-slate-300 border border-slate-600 px-2 py-0.5 rounded-md hover:bg-slate-800">Düzenle</button>
            </div>
            <p className="text-xs sm:text-sm font-semibold mt-1 text-slate-100 leading-snug">{valve.program}</p>
          </div>
        </div>
      );
    };

    const GroupModal = ({ open, onClose, valves, onSave, saving }) => {
      const [selectedIds, setSelectedIds] = useState([]);
      const [groupName, setGroupName] = useState('');

      useEffect(() => {
        if (open) {
          setSelectedIds([]);
          setGroupName('');
        }
      }, [open]);

      const toggleValve = (id) => {
        setSelectedIds((prev) => prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id]);
      };

      if (!open) return null;

      return (
        <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/50">
          <div className="bg-slate-900 border border-slate-700 rounded-2xl p-5 w-full max-w-md shadow-xl">
            <h3 className="text-lg font-semibold text-slate-100 mb-3">Valf Grubu Belirle</h3>
            <p className="text-xs text-slate-400 mb-4">Aşağıdan valfleri seç ve bu gruba bir isim ver. Kaydettiğinde ilgili valflerin <code className="mx-1 px-1 rounded bg-slate-800 text-[10px]">group</code> alanı güncellenecek.</p>
            <label className="block text-xs font-medium text-slate-300 mb-1">Grup adı</label>
            <input type="text" value={groupName} onChange={(e) => setGroupName(e.target.value)} placeholder="Ön Grup, Orta Grup vb." className="w-full mb-3 px-3 py-2 rounded-md bg-slate-800
